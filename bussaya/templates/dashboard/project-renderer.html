{% import '/base/project-material-renderer.html' as pm_renderer %}


{% macro render_project_section(projects, current_user, advisee_projects, committee_projects) -%}
<div class="ui segment row">
  {%- if advisee_projects | count > 0 %}
  <h4>Advisee Project</h4>
  {{ render_current_project_table(advisee_projects, current_user) }}
  {%- endif %}
  {%- if committee_projects | count > 0 %}
  <h4>Examination Project</h4>
  {{ render_current_project_table(committee_projects, current_user) }}
  {%- endif %}
  {%- if projects | count > 0 %}
  <h4>Alumni Project</h4>
  {{ render_project_table(projects, current_user) }}
  {%- endif %}
</div>
{% endmacro -%}

{% macro render_current_project_table(projects, current_user=None) -%}
<table class="ui compact celled table">
  <thead>
    <tr>
      <th>Project</th>
      <th>Student</th>
      <th>Advisor</th>
      <th>Midterm</th>
      <th>Final</th>
    </tr>
  </thead>
  <tbody>
    {% for project in projects %}
    <tr>
      <td>{{ project.name }}</td>
      <td class="right aligned collapsing">
        {%- for s in project.students %}
          {{ s.first_name }} {{ s.last_name }}
        {% if not loop.last %}<br>{% endif %}
        {% endfor -%}
      </td>
      <td class="right aligned collapsing">{{ project.advisor.first_name }} {{ project.advisor.last_name }}</td>
      <td class="right aligned collapsing">
        {% set progress_reports = project.get_progress_reports(round='midterm') %}
        {% for pr in progress_reports %}
          <a target="_blank" href="{{ url_for('submissions.download', progress_report_id=pr.id, filename=pr.file.filename) }}">
            {% if pr.submission.type == 'report' %}
              <i class="file pdf icon large"></i>
            {% elif pr.submission.type == 'presentation' %}
              <i class="file powerpoint icon large"></i>
            {% else %}
              <i class="file alternate icon large"></i>
            {% endif %}
          </a>
        {% endfor %}
      </td>
      <td class="right aligned collapsing">
        {% set progress_reports = project.get_progress_reports(round='final') %}
        {% for pr in progress_reports %}
          <a target="_blank" href="{{ url_for('submissions.download', progress_report_id=pr.id, filename=pr.file.filename) }}">
            {% if pr.submission.type == 'report' %}
              <i class="file pdf icon large"></i>
            {% elif pr.submission.type == 'presentation' %}
              <i class="file powerpoint icon large"></i>
            {% else %}
              <i class="file alternate icon large"></i>
            {% endif %}
          </a>
        {% endfor %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{%- endmacro %}

{% macro render_project_table(projects, current_user=None) -%}
<table class="ui compact celled table">
  <thead>
    <tr>
      <th>Project</th>
      <th>Student</th>
      <th>Advisor</th>
      <th>Public</th>
      <th>Document</th>
      {#
      <th>Action</th>
      #}
    </tr>
  </thead>
  <tbody>
    {% for project in projects %}
    <tr>
      <td>{{ project.name }}</td>
      <td class="right aligned collapsing">
        {%- for s in project.students %}
        <a target="_blank" href="{{ url_for('accounts.profile', user_id=s.id) }}">
          {{ s.first_name }} {{ s.last_name }}
        </a>
        {% if not loop.last %}<br>{% endif %}
        {% endfor -%}
      </td>
      <td class="right aligned collapsing">{{ project.advisor.first_name }} {{ project.advisor.last_name }}</td>
      <td class="right aligned collapsing">{{ project.public.title() }}</td>
      <td class="right aligned collapsing">
        {{ pm_renderer.render_project_material(project) }}
      </td>

      {#
      <td class="right aligned collapsing">
        
        {% if current_user and project.is_approval(current_user) %}
        <i class="large blue check icon"></i>
        <a class="ui disabled button" href="{{ url_for('projects.approve', project_id=project.id) }}">Approve</a>
        {% elif current_user %}
        <i class="large check icon disabled"></i>
        <a class="ui primary button" href="{{ url_for('projects.approve', project_id=project.id) }}">Approve</a>
        {% else %}
        {% endif %}
      </td>
      #}
    </tr>
    {% endfor %}
  </tbody>
</table>

<script type="text/javascript">
  $('.icon.link.pop')
    .popup({
      delay: {
        show: 50,
        hide: 70
      }
    });
</script>
{%- endmacro %}
